# ğŸ—ºï¸ MAPEO ARQUITECTURA COMPLETO - HAIDA

**Generado**: ++34662652300
**Status**: âœ… Verificado y mapeado
**VersiÃ³n**: 1.0

---

## ğŸ“ ARQUITECTURA DE ALTO NIVEL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        USUARIOS FINALES                               â”‚
â”‚                    (Navegador, Teams, Mobile)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â–²
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                        â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  FRONTEND REACT    â”‚   â”‚ COPILOT STUDIO    â”‚
         â”‚ (haida.stayarta.com)   â”‚ (Teams Integration)â”‚
         â”‚  Vite + React 18   â”‚   â”‚  DirectLine API   â”‚
         â”‚  TypeScript, TailwindCSSâ”‚                  â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   MICROSOFT ENTRA ID   â”‚
                    â”‚  (OAuth2 / SSO Flow)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
    â”‚ FASTAPI   â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚  SUPABASE   â”‚â—„â”€â”€â”€â”€â”€â–ºâ”‚ PostgreSQL  â”‚
    â”‚ BACKEND   â”‚        â”‚  (Auth)     â”‚        â”‚ (Database)  â”‚
    â”‚ Productionâ”‚        â”‚             â”‚        â”‚             â”‚
    â”‚haidapi.   â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚stayarta.  â”‚
    â”‚com        â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                              â”‚
    â”œâ”€ /auth (Local login)         â”‚
    â”œâ”€ /entra (Microsoft SSO)      â”‚
    â”œâ”€ /api/projects (CRUD)        â”‚
    â”œâ”€ /api/test-cases (Scripts)   â”‚
    â”œâ”€ /api/test-runs (EjecuciÃ³n)  â”‚
    â”œâ”€ /chat (IA Integration)      â”‚
    â”œâ”€ /reports (ReporterÃ­a)       â”‚
    â”œâ”€ /files (GestiÃ³n archivos)   â”‚
    â”œâ”€ /notifications (Alertas)    â”‚
    â””â”€ /openapi.json (API Spec)    â”‚
```

---

## ğŸ¯ MAPEO DETALLADO POR COMPONENTE

---

## 1ï¸âƒ£ FRONTEND - REACT + VITE

### ğŸ“ UBICACIÃ“N
```
/Users/carlosa/00-PROJECTS/HAIDA/haida-production/main/
```

### ğŸ“ ESTRUCTURA
```
haida-production/main/
â”œâ”€â”€ src/                              # Source code
â”‚   â”œâ”€â”€ components/                   # React components
â”‚   â”‚   â”œâ”€â”€ Dashboard/
â”‚   â”‚   â”œâ”€â”€ Projects/
â”‚   â”‚   â”œâ”€â”€ TestCases/
â”‚   â”‚   â”œâ”€â”€ Reports/
â”‚   â”‚   â”œâ”€â”€ Chat/                    # AI Chat widget
â”‚   â”‚   â””â”€â”€ common/                  # Shared components
â”‚   â”œâ”€â”€ pages/                       # Page components
â”‚   â”œâ”€â”€ hooks/                       # Custom React hooks
â”‚   â”œâ”€â”€ services/                    # API calls
â”‚   â”‚   â”œâ”€â”€ api.ts                  # Axios instance
â”‚   â”‚   â”œâ”€â”€ supabase.ts             # Supabase client
â”‚   â”‚   â”œâ”€â”€ projects.ts             # Project API calls
â”‚   â”‚   â”œâ”€â”€ testCases.ts            # Test case API calls
â”‚   â”‚   â””â”€â”€ reports.ts              # Report API calls
â”‚   â”œâ”€â”€ store/                       # State management
â”‚   â”œâ”€â”€ types/                       # TypeScript types
â”‚   â”œâ”€â”€ styles/                      # Global styles
â”‚   â”œâ”€â”€ App.tsx                      # Main component
â”‚   â””â”€â”€ main.tsx                     # Entry point
â”œâ”€â”€ dist/                            # Build output (Vercel)
â”œâ”€â”€ package.json                     # â­ Frontend dependencies
â”œâ”€â”€ vite.config.ts                   # Vite configuration
â”œâ”€â”€ tsconfig.json                    # TypeScript config
â”œâ”€â”€ tailwind.config.ts               # Tailwind CSS config
â””â”€â”€ .env.local                       # ğŸ” Local environment variables
```

### ğŸ”§ CONFIGURACIÃ“N VITE

**Archivo**: `vite.config.ts`
```typescript
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    proxy: {
      '/api': 'http://localhost:8000',
      '/auth': 'http://localhost:8000',
    }
  },
  build: {
    outDir: 'dist',
    sourcemap: true
  }
})
```

### ğŸ“¦ PACKAGE.JSON
**Archivo**: `package.json`
```json
{
  "name": "haida-frontend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "test:web": "playwright test",
    "test:web:ui": "playwright test --ui"
  },
  "dependencies": {
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "@supabase/supabase-js": "^2.89.0",
    "axios": "^1.7.2",
    "zod": "^4.2.1",
    "@radix-ui/react-*": "latest",
    "tailwindcss": "^4.1.12"
  },
  "devDependencies": {
    "typescript": "^5.7.2",
    "vite": "^6.3.6",
    "@types/react": "^18.3.11",
    "@playwright/test": "^1.48.0"
  }
}
```

### ğŸŒ VARIABLES DE ENTORNO (.env.local)
```env
VITE_API_URL=https://haidapi.stayarta.com
VITE_SUPABASE_URL=https://wdebyxvtunromsnkqbrd.supabase.co
VITE_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
VITE_APP_URL=https://haida.stayarta.com
VITE_COPILOT_ENDPOINT=https://default...
```

### ğŸ“¤ BUILD & DEPLOYMENT

**Local Development**:
```bash
npm install
npm run dev                    # http://localhost:5173
```

**Production Build**:
```bash
npm run build                  # Genera dist/
```

**Vercel Deployment**:
- **Framework Detected**: Vite
- **Build Command**: `npm run build`
- **Output Directory**: `dist/`
- **Install Command**: `npm ci`
- **Public Directory**: `dist/`

### ğŸ”— API INTEGRATION

**Base URL**: `https://haidapi.stayarta.com`

**Axios Instance** (`services/api.ts`):
```typescript
import axios from 'axios'

const apiClient = axios.create({
  baseURL: import.meta.env.VITE_API_URL,
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${token}`
  }
})

export default apiClient
```

**Endpoints usados**:
```
GET  /openapi.json              # Swagger spec
GET  /health                    # Health check
POST /auth/login                # Local login
GET  /entra/authorize           # Microsoft SSO
GET  /api/projects              # List projects
POST /api/projects              # Create project
GET  /api/projects/:id          # Get project
GET  /api/test-cases            # List test cases
POST /api/test-cases            # Create test case
GET  /chat/completions          # Chat API
```

---

## 2ï¸âƒ£ BACKEND - FASTAPI (PYTHON)

### ğŸ“ UBICACIÃ“N
```
/Users/carlosa/00-PROJECTS/HAIDA/haida-production/main/
```

### ğŸ“ ESTRUCTURA
```
haida-production/main/
â”œâ”€â”€ api/                             # â­ Vercel entry point
â”‚   â””â”€â”€ index.py                    # Wrapper para Vercel
â”œâ”€â”€ app/                            # â­ FastAPI application
â”‚   â”œâ”€â”€ main.py                     # Application entry point
â”‚   â”œâ”€â”€ core/                       # Core utilities
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ config.py              # Config management
â”‚   â”‚   â”œâ”€â”€ logging.py             # Logging setup
â”‚   â”‚   â”œâ”€â”€ middleware.py          # Custom middleware
â”‚   â”‚   â”œâ”€â”€ cors.py                # CORS configuration
â”‚   â”‚   â”œâ”€â”€ jwt_auth.py            # JWT authentication
â”‚   â”‚   â”œâ”€â”€ rbac.py                # Role-based access control
â”‚   â”‚   â”œâ”€â”€ tenants.py             # Multi-tenancy
â”‚   â”‚   â”œâ”€â”€ i18n.py                # Internationalization
â”‚   â”‚   â”œâ”€â”€ limiter.py             # Rate limiting
â”‚   â”‚   â””â”€â”€ exceptions.py          # Custom exceptions
â”‚   â”œâ”€â”€ db/                        # Database layer
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ database.py            # Connection pool
â”‚   â”‚   â”œâ”€â”€ models.py              # SQLAlchemy models
â”‚   â”‚   â”œâ”€â”€ schemas.py             # Pydantic schemas
â”‚   â”‚   â””â”€â”€ crud.py                # CRUD operations
â”‚   â”œâ”€â”€ models/                    # Data models
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ project.py
â”‚   â”‚   â”œâ”€â”€ test_case.py
â”‚   â”‚   â”œâ”€â”€ test_execution.py
â”‚   â”‚   â””â”€â”€ report.py
â”‚   â”œâ”€â”€ routes/                    # API endpoints
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth.py               # POST /auth/login, /register
â”‚   â”‚   â”œâ”€â”€ entra.py              # GET /entra/authorize
â”‚   â”‚   â”œâ”€â”€ projects.py           # CRUD /api/projects
â”‚   â”‚   â”œâ”€â”€ scripts.py            # CRUD /api/test-cases
â”‚   â”‚   â”œâ”€â”€ runs.py               # POST /api/test-runs
â”‚   â”‚   â”œâ”€â”€ reports.py            # GET /api/reports
â”‚   â”‚   â”œâ”€â”€ chat.py               # POST /chat/completions
â”‚   â”‚   â”œâ”€â”€ notifications.py      # GET /notifications
â”‚   â”‚   â”œâ”€â”€ docs.py               # GET /docs
â”‚   â”‚   â”œâ”€â”€ files.py              # POST /files/upload
â”‚   â”‚   â”œâ”€â”€ admin.py              # Admin endpoints
â”‚   â”‚   â””â”€â”€ system.py             # /health, /status, /version
â”‚   â”œâ”€â”€ services/                 # Business logic
â”‚   â”‚   â”œâ”€â”€ auth_service.py       # Auth logic
â”‚   â”‚   â”œâ”€â”€ entra_service.py      # Microsoft SSO (MSAL)
â”‚   â”‚   â”œâ”€â”€ project_service.py    # Project management
â”‚   â”‚   â”œâ”€â”€ test_service.py       # Test case logic
â”‚   â”‚   â”œâ”€â”€ chat_service.py       # AI chat logic
â”‚   â”‚   â”œâ”€â”€ report_service.py     # Report generation
â”‚   â”‚   â””â”€â”€ email_service.py      # Email notifications
â”‚   â”œâ”€â”€ schemas/                  # Pydantic validation
â”‚   â”‚   â”œâ”€â”€ user.py
â”‚   â”‚   â”œâ”€â”€ project.py
â”‚   â”‚   â”œâ”€â”€ test_case.py
â”‚   â”‚   â””â”€â”€ responses.py
â”‚   â”œâ”€â”€ ai/                       # AI integration
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat_handler.py       # Chat completions
â”‚   â”‚   â”œâ”€â”€ test_generator.py     # AI test generation
â”‚   â”‚   â””â”€â”€ prompts.py            # System prompts
â”‚   â””â”€â”€ utils/                    # Utilities
â”‚       â”œâ”€â”€ validators.py
â”‚       â”œâ”€â”€ formatters.py
â”‚       â””â”€â”€ helpers.py
â”œâ”€â”€ requirements.txt              # â­ Python dependencies
â”œâ”€â”€ vercel.json                   # â­ Vercel configuration
â”œâ”€â”€ docker-compose.yml            # â­ Docker setup
â””â”€â”€ .env.local                    # ğŸ” Environment variables
```

### ğŸ”§ MAIN.PY - CONFIGURACIÃ“N FASTAPI

**Archivo**: `app/main.py`
```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi_limiter import FastAPILimiter
from redis import asyncio as aioredis

# Application instance
app = FastAPI(
    title="HAIDA Backend API",
    description="AI-Driven QA Automation Platform",
    version="2.0.0",
    docs_url="/docs",
    openapi_url="/openapi.json"
)

# CORS middleware
app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "https://haida-frontend.vercel.app",
        "https://haida.stayarta.com",
        "http://localhost:3000",
        "http://localhost:5173"
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Rate limiting
@app.on_event("startup")
async def startup():
    redis = aioredis.from_url("redis://localhost")
    await FastAPILimiter.init(redis)

# Include routers
from app.routes import (
    auth, entra, projects, scripts, runs,
    reports, chat, notifications, files, admin, system
)

app.include_router(system.router, tags=["System"])
app.include_router(auth.router, prefix="/auth", tags=["Auth"])
app.include_router(entra.router, prefix="/entra", tags=["Microsoft"])
app.include_router(projects.router, prefix="/api/projects", tags=["Projects"])
app.include_router(scripts.router, prefix="/api/test-cases", tags=["Test Cases"])
app.include_router(runs.router, prefix="/api/test-runs", tags=["Execution"])
app.include_router(reports.router, prefix="/api/reports", tags=["Reports"])
app.include_router(chat.router, prefix="/chat", tags=["Chat"])
```

### ğŸ“¦ REQUIREMENTS.TXT

**Archivo**: `requirements.txt`
```
# Web Framework
fastapi==0.115.6
uvicorn==0.34.0
python-dotenv==1.0.1

# Data Validation
pydantic==2.10.6
pydantic-settings==2.2.1

# Database
psycopg2-binary==2.9.10
supabase==2.9.1
sqlalchemy==2.0.35

# Authentication
pyjwt==2.10.1
python-jose[cryptography]==3.3.0
msal==1.31.1
httpx==0.27.2

# LLM/AI
openai==1.48.0
anthropic==0.39.0

# Redis (Cache/Sessions)
redis==5.1.1
aioredis==2.0.1

# Utilities
requests==2.32.3
python-multipart==0.0.6
python-dateutil==2.9.0.post0

# Logging
python-json-logger==2.0.7

# Rate limiting
slowapi==0.1.9
```

### ğŸ” VERCEL ENTRY POINT

**Archivo**: `api/index.py`
```python
from fastapi import FastAPI
from fastapi.middleware.wsgi import WSGIMiddleware
from app.main import app as fastapi_app

# Wrap FastAPI app for Vercel
app = fastapi_app

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

### ğŸŒ VARIABLES DE ENTORNO (.env.local)

```env
# FastAPI Config
NODE_ENV=production
PORT=3001
BASE_URL=https://mcprod.thisisbarcelona.com

# Database (Supabase PostgreSQL)
DATABASE_URL=postgresql://postgres.wdebyxvtunromsnkqbrd:hola@stayarta.com:6543/postgres?sslmode=require
SUPABASE_URL=https://wdebyxvtunromsnkqbrd.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# JWT Authentication
JWT_SECRET=ECB76E37-DB86-435A-9E17-3DEF19FF57A7
JWT_ALGORITHM=HS256
JWT_EXPIRATION_MINUTES=30

# Microsoft Entra ID (SSO)
ENTRA_AUTHORITY=https://login.microsoftonline.com/9b7594d6-2c7d-4fe2-b248-213f64996877
ENTRA_CLIENT_ID=93dae11f-417c-49ff-8d66-d642afb66327
ENTRA_CLIENT_SECRET=6GI8Q~kMgGHrl9AvhGfAiOUQp7xAqzTqncvCca3p
ENTRA_REDIRECT_URI=https://haida.stayarta.com/auth

# CORS
CORS_ORIGINS=https://haida-frontend.vercel.app,https://haida.stayarta.com,http://localhost:3000,http://localhost:5173

# Redis
REDIS_URL=redis://localhost:6379

# LLM Configuration
OPENAI_API_KEY=sk-...
ANTHROPIC_API_KEY=sk-ant-...
ROUTE_LLM_URL=https://routellm.abacus.ai/v1
ROUTE_LLM_MODEL=gpt-5

# Email (SMTP)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=hola@stayarta.com
SMTP_PASSWORD=app-password

# Logging
LOG_LEVEL=INFO
DEBUG=false
```

### ğŸš€ API ENDPOINTS

| Method | Endpoint | Router | Description | Auth |
|--------|----------|--------|-------------|------|
| GET | `/health` | system | Health check | âŒ |
| GET | `/version` | system | API version | âŒ |
| GET | `/openapi.json` | system | OpenAPI spec | âŒ |
| POST | `/auth/login` | auth | Local login | âŒ |
| POST | `/auth/register` | auth | User registration | âŒ |
| POST | `/auth/logout` | auth | Logout | âœ… JWT |
| POST | `/auth/refresh` | auth | Refresh token | âœ… JWT |
| GET | `/entra/authorize` | entra | Microsoft SSO | âŒ |
| GET | `/entra/callback` | entra | OAuth callback | âŒ |
| GET | `/api/projects` | projects | List projects | âœ… JWT |
| POST | `/api/projects` | projects | Create project | âœ… JWT |
| GET | `/api/projects/{id}` | projects | Get project | âœ… JWT |
| PUT | `/api/projects/{id}` | projects | Update project | âœ… JWT |
| DELETE | `/api/projects/{id}` | projects | Delete project | âœ… JWT |
| GET | `/api/test-cases` | scripts | List test cases | âœ… JWT |
| POST | `/api/test-cases` | scripts | Create test case | âœ… JWT |
| GET | `/api/test-runs` | runs | List executions | âœ… JWT |
| POST | `/api/test-runs` | runs | Execute test | âœ… JWT |
| GET | `/api/reports` | reports | List reports | âœ… JWT |
| POST | `/api/reports/generate` | reports | Generate report | âœ… JWT |
| POST | `/chat/completions` | chat | Chat with AI | âœ… JWT |
| GET | `/notifications` | notifications | Get alerts | âœ… JWT |
| POST | `/files/upload` | files | Upload file | âœ… JWT |

### ğŸ“¡ ROUTING ARCHITECTURE

**Vercel Routes** (`vercel.json`):
```json
{
  "version": 2,
  "builds": [
    { "src": "api/index.py", "use": "@vercel/python" }
  ],
  "routes": [
    { "src": "/health", "dest": "/api/index.py" },
    { "src": "/version", "dest": "/api/index.py" },
    { "src": "/status", "dest": "/api/index.py" },
    { "src": "/auth/(.*)", "dest": "/api/index.py" },
    { "src": "/entra/(.*)", "dest": "/api/index.py" },
    { "src": "/api/(.*)", "dest": "/api/index.py" },
    { "src": "/chat/(.*)", "dest": "/api/index.py" },
    { "src": "/notifications/(.*)", "dest": "/api/index.py" },
    { "src": "/reports/(.*)", "dest": "/api/index.py" },
    { "src": "/files/(.*)", "dest": "/api/index.py" },
    { "src": "/docs", "dest": "/api/index.py" },
    { "src": "/openapi.json", "dest": "/api/index.py" },
    { "src": "/(.*)", "dest": "/api/index.py" }
  ]
}
```

---

## 3ï¸âƒ£ BASE DE DATOS - SUPABASE / POSTGRESQL

### ğŸ“ UBICACIÃ“N ARCHIVOS
```
/Users/carlosa/00-PROJECTS/HAIDA/haida-production/main/database/
```

### ğŸ—„ï¸ ESTRUCTURA DATABASE

```
database/
â”œâ”€â”€ 01-schema-haida.sql              # â­ Schema principal
â”œâ”€â”€ 02-test-data.sql                 # Datos de prueba
â”œâ”€â”€ 03-migration-add-full-name.sql   # MigraciÃ³n
â”œâ”€â”€ 04-realtime-features.sql         # Realtime subscriptions
â”œâ”€â”€ FIX-RLS-POLICIES.sql             # Row-level security
â”œâ”€â”€ setup-ctb-complete.sql           # Setup completo
â””â”€â”€ README-DATABASE.md               # DocumentaciÃ³n
```

### ğŸ“Š TABLAS PRINCIPALES

#### **users** (Usuarios)
```sql
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  full_name VARCHAR(255),                    -- Migrado de 'name'
  role VARCHAR(50) DEFAULT 'viewer',         -- viewer, editor, admin
  is_active BOOLEAN DEFAULT true,
  last_login_at TIMESTAMP,
  metadata JSONB DEFAULT '{}',               -- Extra fields
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- Ãndices
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
```

#### **projects** (Proyectos)
```sql
CREATE TABLE projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  slug VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  base_url VARCHAR(500) NOT NULL,
  repository_url VARCHAR(500),
  status VARCHAR(50) DEFAULT 'active',      -- active, archived, deleted
  owner_id UUID REFERENCES users(id),
  settings JSONB DEFAULT '{}',              -- Webhooks, notifications
  metadata JSONB DEFAULT '{}',              -- Custom fields
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (owner_id) REFERENCES users(id)
);

-- Ãndices
CREATE INDEX idx_projects_slug ON projects(slug);
CREATE INDEX idx_projects_owner_id ON projects(owner_id);
```

#### **test_suites** (Suite de Tests)
```sql
CREATE TABLE test_suites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  suite_type VARCHAR(50) NOT NULL,          -- smoke, regression, e2e, api, performance, a11y, security
  priority VARCHAR(20) DEFAULT 'medium',    -- critical, high, medium, low
  tags TEXT[] DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  created_by UUID REFERENCES users(id),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- Ãndices
CREATE INDEX idx_test_suites_project_id ON test_suites(project_id);
CREATE INDEX idx_test_suites_suite_type ON test_suites(suite_type);
```

#### **test_cases** (Casos de Prueba - ISTQB)
```sql
CREATE TABLE test_cases (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  test_suite_id UUID NOT NULL REFERENCES test_suites(id) ON DELETE CASCADE,
  test_id VARCHAR(50) UNIQUE NOT NULL,      -- TC_LOGIN_001
  name VARCHAR(255) NOT NULL,
  description TEXT,

  -- ISTQB Fields
  test_type VARCHAR(50) NOT NULL,           -- Functional, Negative, Security, Performance, etc
  component VARCHAR(100),                   -- UI Component name
  module VARCHAR(100),                      -- Feature module
  requirement_ids TEXT[] DEFAULT '{}',      -- Traceability
  preconditions TEXT,
  test_steps TEXT NOT NULL,
  expected_result TEXT NOT NULL,
  priority VARCHAR(20) DEFAULT 'medium',
  risk_level VARCHAR(20) DEFAULT 'medium',

  -- Automation
  is_automated BOOLEAN DEFAULT false,
  automation_script_path VARCHAR(500),
  automation_framework VARCHAR(50),         -- playwright, newman, k6, lighthouse

  status VARCHAR(50) DEFAULT 'active',      -- active, deprecated, archived
  tags TEXT[] DEFAULT '{}',
  created_by UUID REFERENCES users(id),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (test_suite_id) REFERENCES test_suites(id)
);

-- Ãndices
CREATE INDEX idx_test_cases_test_id ON test_cases(test_id);
CREATE INDEX idx_test_cases_suite_id ON test_cases(test_suite_id);
CREATE INDEX idx_test_cases_component ON test_cases(component);
```

#### **test_executions** (Ejecuciones)
```sql
CREATE TABLE test_executions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  test_case_id UUID NOT NULL REFERENCES test_cases(id),
  project_id UUID NOT NULL REFERENCES projects(id),

  status VARCHAR(50) NOT NULL,              -- passed, failed, skipped, blocked
  started_at TIMESTAMP NOT NULL,
  completed_at TIMESTAMP,
  duration_ms INTEGER,

  environment VARCHAR(50),                  -- dev, staging, production
  browser VARCHAR(50),                      -- chrome, firefox, safari, edge
  os_platform VARCHAR(50),                  -- windows, macos, linux

  error_message TEXT,
  error_details JSONB,

  retry_count INTEGER DEFAULT 0,
  is_flaky BOOLEAN DEFAULT false,

  attachments JSONB DEFAULT '{}',          -- Screenshots, videos
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (test_case_id) REFERENCES test_cases(id),
  FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- Ãndices
CREATE INDEX idx_test_executions_status ON test_executions(status);
CREATE INDEX idx_test_executions_project_id ON test_executions(project_id);
CREATE INDEX idx_test_executions_created_at ON test_executions(created_at);
```

#### **test_results** (Resultados Agregados)
```sql
CREATE TABLE test_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  test_case_id UUID NOT NULL REFERENCES test_cases(id),
  execution_id UUID NOT NULL REFERENCES test_executions(id),

  result VARCHAR(50) NOT NULL,              -- pass, fail, error, skip
  details JSONB,

  assertions_total INTEGER,
  assertions_passed INTEGER,
  assertions_failed INTEGER,

  performance_metrics JSONB,                -- Load time, memory, CPU
  screenshots TEXT[],
  video_url VARCHAR(500),

  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (test_case_id) REFERENCES test_cases(id),
  FOREIGN KEY (execution_id) REFERENCES test_executions(id)
);

-- Ãndices
CREATE INDEX idx_test_results_result ON test_results(result);
CREATE INDEX idx_test_results_execution_id ON test_results(execution_id);
```

#### **change_detections** (DetecciÃ³n de Cambios)
```sql
CREATE TABLE change_detections (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id),

  url VARCHAR(500) NOT NULL,
  tag VARCHAR(100),

  last_checked_at TIMESTAMP,
  last_change_detected_at TIMESTAMP,

  change_type VARCHAR(50),                  -- visual, content, performance, error
  change_details JSONB,

  is_active BOOLEAN DEFAULT true,
  trigger_test_suites UUID[] DEFAULT '{}', -- Suites to run on change

  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- Ãndices
CREATE INDEX idx_change_detections_url ON change_detections(url);
CREATE INDEX idx_change_detections_project_id ON change_detections(project_id);
```

#### **reports** (ReporterÃ­a)
```sql
CREATE TABLE reports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID REFERENCES projects(id),

  title VARCHAR(255) NOT NULL,
  description TEXT,

  report_type VARCHAR(50) NOT NULL,        -- summary, detailed, trend, comparison
  format VARCHAR(20) DEFAULT 'html',       -- html, pdf, excel, json

  test_execution_ids UUID[] DEFAULT '{}',  -- Executions included

  metrics JSONB,                           -- Pass rate, avg time, etc
  summary JSONB,

  generated_by UUID REFERENCES users(id),
  generated_at TIMESTAMP NOT NULL,
  expiry_at TIMESTAMP,                     -- Auto-delete after

  s3_url VARCHAR(500),                     -- Report file location
  is_public BOOLEAN DEFAULT false,

  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (project_id) REFERENCES projects(id)
);

-- Ãndices
CREATE INDEX idx_reports_project_id ON reports(project_id);
CREATE INDEX idx_reports_generated_at ON reports(generated_at);
```

### ğŸ” SEGURIDAD - RLS POLICIES

```sql
-- Users can only see their own projects
CREATE POLICY "users_view_own_projects" ON projects
  FOR SELECT USING (owner_id = auth.uid());

-- Users can only update their own projects
CREATE POLICY "users_update_own_projects" ON projects
  FOR UPDATE USING (owner_id = auth.uid());

-- Test results visible only to project members
CREATE POLICY "test_results_visible_to_members" ON test_results
  FOR SELECT USING (
    EXISTS (SELECT 1 FROM projects
            WHERE projects.id = test_results.project_id
            AND (projects.owner_id = auth.uid() OR true))
  );
```

### ğŸ”— CONEXIÃ“N DESDE CÃ“DIGO

**Python (Backend)** - `app/db/database.py`:
```python
from supabase import create_client, Client
from sqlalchemy import create_engine

# Supabase connection
SUPABASE_URL = os.getenv("SUPABASE_URL")
SUPABASE_KEY = os.getenv("SUPABASE_ANON_KEY")
supabase: Client = create_client(SUPABASE_URL, SUPABASE_KEY)

# PostgreSQL connection (SQLAlchemy)
DATABASE_URL = os.getenv("DATABASE_URL")
engine = create_engine(DATABASE_URL)

# Session factory
from sqlalchemy.orm import sessionmaker
SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)
```

**JavaScript (Frontend)** - `services/supabase.ts`:
```typescript
import { createClient } from '@supabase/supabase-js'

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL
const SUPABASE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY

export const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

// Usage
const { data, error } = await supabase
  .from('projects')
  .select('*')
  .eq('owner_id', userId)
```

### ğŸ“ˆ DIAGRAMA RELACIONES ER

```
users (1)
  â”œâ”€ (N) projects
  â”‚   â”œâ”€ (N) test_suites
  â”‚   â”‚   â”œâ”€ (N) test_cases
  â”‚   â”‚   â”‚   â”œâ”€ (N) test_executions
  â”‚   â”‚   â”‚   â”‚   â””â”€ (N) test_results
  â”‚   â”‚   â”‚   â””â”€ (N) change_detections
  â”‚   â”‚   â””â”€ (1) change_detections
  â”‚   â”‚       â””â”€ trigger_test_suites[]
  â”‚   â””â”€ (N) reports
  â”‚
  â””â”€ (N) test_executions (executed_by)
      â””â”€ (N) reports (generated_by)
```

---

## ğŸ”„ FLUJO DE DATOS COMPLETO

### 1ï¸âƒ£ USUARIO INICIA SESIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Usuario en https://haida.stayarta.com      â”‚
â”‚  (Frontend React)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Â¿Usar SSO OAuth?   â”‚
        â”‚ SÃ­ / No            â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                 â”‚
    â–¼ SSO            â–¼ Local
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Redirect to:    â”‚  â”‚ POST /auth/login â”‚
â”‚ Microsoft       â”‚  â”‚ {email,password} â”‚
â”‚ login.          â”‚  â”‚                  â”‚
â”‚ microsoftonline â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ .com/TENANT_ID  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â–¼
         â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚          â”‚ Backend FastAPI     â”‚
         â”‚          â”‚ Verify credentials  â”‚
         â”‚          â”‚ Check users table   â”‚
         â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚
         â–¼ MSAL callback â—„â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /entra/callback â”‚
â”‚ {auth_code}          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Backend exchanges code  â”‚
  â”‚ for access token        â”‚
  â”‚ (MSAL library)          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Create/Update user in DB     â”‚
  â”‚ INSERT/UPDATE users table    â”‚
  â”‚ (Supabase PostgreSQL)        â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Generate JWT token           â”‚
  â”‚ (signed with JWT_SECRET)     â”‚
  â”‚ Expires: 30 minutes          â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ Return to Frontend:          â”‚
  â”‚ {token, user_id, role}       â”‚
  â”‚ Stored in localStorage       â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2ï¸âƒ£ USUARIO CREA PROYECTO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend:                       â”‚
â”‚ POST /api/projects              â”‚
â”‚ {name, description, base_url}   â”‚
â”‚ Header: Authorization: Bearer JWT
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend FastAPI:               â”‚
â”‚ POST /api/projects handler     â”‚
â”‚                                â”‚
â”‚ 1. Verify JWT token            â”‚
â”‚ 2. Validate input (Pydantic)   â”‚
â”‚ 3. Generate slug from name     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database Operation:            â”‚
â”‚                                â”‚
â”‚ INSERT INTO projects           â”‚
â”‚ (id, name, slug, base_url,     â”‚
â”‚  owner_id=current_user,        â”‚
â”‚  status='active')              â”‚
â”‚                                â”‚
â”‚ Returns: project_id (UUID)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response to Frontend:          â”‚
â”‚ Status: 201 Created            â”‚
â”‚ {project_id, name, slug, ...}  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3ï¸âƒ£ USUARIO CREA CASO DE PRUEBA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend:                             â”‚
â”‚ POST /api/test-cases                  â”‚
â”‚ {project_id, name, test_steps, ...}   â”‚
â”‚ Header: Authorization: Bearer JWT     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend FastAPI:                     â”‚
â”‚ Validate user owns project           â”‚
â”‚ Validate ISTQB format fields         â”‚
â”‚ Generate test_id (TC_001, TC_002)    â”‚
â”‚ Generate UUID for test case ID       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:                            â”‚
â”‚                                      â”‚
â”‚ INSERT INTO test_cases               â”‚
â”‚ (test_suite_id, test_id, name,       â”‚
â”‚  test_steps, expected_result, ...)   â”‚
â”‚                                      â”‚
â”‚ Returns: test_case_id (UUID)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4ï¸âƒ£ USUARIO EJECUTA PRUEBA

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend:                            â”‚
â”‚ POST /api/test-runs                 â”‚
â”‚ {test_case_id, project_id}          â”‚
â”‚ Header: Authorization: Bearer JWT   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend FastAPI:                    â”‚
â”‚ 1. Get test case details            â”‚
â”‚ 2. Create execution record          â”‚
â”‚ 3. Execute based on framework:      â”‚
â”‚    - If Playwright: trigger script  â”‚
â”‚    - If Newman: run Postman API     â”‚
â”‚    - If k6: trigger perf test       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:                           â”‚
â”‚                                     â”‚
â”‚ INSERT INTO test_executions         â”‚
â”‚ (test_case_id, status='running',    â”‚
â”‚  started_at=NOW())                  â”‚
â”‚                                     â”‚
â”‚ Returns: execution_id (UUID)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
        [Test Running]
        (5-30 seconds)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:                            â”‚
â”‚                                      â”‚
â”‚ UPDATE test_executions               â”‚
â”‚ SET status='passed',                 â”‚
â”‚     completed_at=NOW(),              â”‚
â”‚     duration_ms=5432                 â”‚
â”‚ WHERE id=execution_id                â”‚
â”‚                                      â”‚
â”‚ INSERT INTO test_results             â”‚
â”‚ (test_case_id, execution_id,         â”‚
â”‚  result='pass',                      â”‚
â”‚  assertions_passed=10)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response to Frontend:                â”‚
â”‚ Status: 200 OK                       â”‚
â”‚ {execution_id, result, duration_ms,  â”‚
â”‚  timestamp}                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5ï¸âƒ£ USUARIO GENERA REPORTE

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend:                            â”‚
â”‚ POST /api/reports/generate           â”‚
â”‚ {project_id, format='pdf'}           â”‚
â”‚ Header: Authorization: Bearer JWT    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend FastAPI:                     â”‚
â”‚ 1. Query test_executions where       â”‚
â”‚    project_id=X and                  â”‚
â”‚    created_at > last_30_days         â”‚
â”‚ 2. Calculate metrics:                â”‚
â”‚    - Pass rate = passes/total        â”‚
â”‚    - Avg duration                    â”‚
â”‚    - Failed tests                    â”‚
â”‚ 3. Generate HTML/PDF                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database:                            â”‚
â”‚                                      â”‚
â”‚ INSERT INTO reports                  â”‚
â”‚ (project_id, title, format,          â”‚
â”‚  metrics, generated_by,              â”‚
â”‚  generated_at=NOW())                 â”‚
â”‚                                      â”‚
â”‚ Returns: report_id (UUID)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… CHECKLIST DE VERIFICACION

### Frontend
- [âœ…] UbicaciÃ³n: `/haida-production/main/`
- [âœ…] Build tool: Vite 6.3.6
- [âœ…] Framework: React 18.3.1
- [âœ…] Language: TypeScript 5.7.2
- [âœ…] Styles: TailwindCSS 4.1.12
- [âœ…] API Client: Axios
- [âœ…] Database Client: @supabase/supabase-js
- [âœ…] Deployment: Vercel (haida-frontend.vercel.app â†’ haida.stayarta.com)
- [âœ…] Entry: http://localhost:5173 (dev) / https://haida.stayarta.com (prod)

### Backend
- [âœ…] UbicaciÃ³n: `/haida-production/main/`
- [âœ…] Framework: FastAPI 0.115.6
- [âœ…] Language: Python 3.9+
- [âœ…] ASGI Server: Uvicorn 0.34.0
- [âœ…] Database Client: Supabase SDK 2.9.1, SQLAlchemy 2.0.35
- [âœ…] Authentication: PyJWT 2.10.1, MSAL 1.31.1
- [âœ…] Deployment: Vercel Serverless (haida-one.vercel.app â†’ haidapi.stayarta.com)
- [âœ…] Entry point: `api/index.py` (Vercel) / `app/main.py` (FastAPI)
- [âœ…] Routers: 11+ routers (auth, entra, projects, scripts, etc)

### Database
- [âœ…] Provider: Supabase (PostgreSQL managed)
- [âœ…] URL: https://wdebyxvtunromsnkqbrd.supabase.co
- [âœ…] Schema files: 6+ migration files
- [âœ…] Tables: 8 main tables (users, projects, test_suites, test_cases, etc)
- [âœ…] Security: RLS policies enabled
- [âœ…] Connection: Via SUPABASE_URL + SUPABASE_ANON_KEY
- [âœ…] Migrations: Apply via `psql` or Python scripts

### Integration
- [âœ…] Frontend â†’ Backend: Axios to https://haidapi.stayarta.com/api/*
- [âœ…] Backend â†’ Database: Supabase SDK + SQLAlchemy ORM
- [âœ…] Authentication: JWT tokens (30 min expiry)
- [âœ…] SSO: Microsoft Entra ID via MSAL
- [âœ…] API Documentation: OpenAPI spec at /openapi.json

---

## ğŸ”§ PRÃ“XIMOS PASOS RECOMENDADOS

1. **Separar Base de Datos Dev/Prod**
   - Crear segundo proyecto Supabase para desarrollo
   - Actualizar `.env.local` con DB dev

2. **Consolidar Variables de Entorno**
   - Eliminar archivos .env duplicados
   - Usar Vercel Environment Variables
   - Documentar jerarquÃ­a de configuraciÃ³n

3. **Mejorar Seguridad**
   - Rotar secretos (JWT_SECRET, ENTRA_CLIENT_SECRET)
   - Implementar secret rotation automÃ¡tica
   - Auditar credenciales expuestas

4. **Optimizar Performance**
   - Implementar caching en Redis
   - AÃ±adir indexaciÃ³n de BD
   - Monitorizar con Application Insights

5. **Documentar CI/CD**
   - Documenter GitHub Actions workflows
   - Setup automated tests antes de deploy
   - Implementar feature flags

---

**Ãšltima actualizaciÃ³n**: ++34662652300
**Verificado por**: Claude (HAIDA Verification Agent)
**Status**: ğŸŸ¢ Mapeado y verificado correctamente
