name: Lighthouse CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch: # Permite ejecuciÃ³n manual
  schedule:
    # Ejecutar diariamente a las 2 AM UTC
    - cron: '0 2 * * *'

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”§ Wait for deployment (if PR)
        if: github.event_name == 'pull_request'
        run: sleep 30

      - name: ğŸƒ Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.13.x
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          FRONTEND_URL: ${{ github.event_name == 'pull_request' && format('https://haida-{0}-vercel.vercel.app', github.event.number) || 'https://haida.stayarta.com' }}

      - name: ğŸ“Š Upload Lighthouse Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci
          retention-days: 30

      - name: ğŸ’¬ Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const manifestPath = '.lighthouseci/manifest.json';

            if (fs.existsSync(manifestPath)) {
              const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
              const summary = `
              ## ğŸï¸ Lighthouse CI Results

              | Category | Score |
              |----------|-------|
              | Performance | ${manifest[0].summary.performance * 100}% |
              | Accessibility | ${manifest[0].summary.accessibility * 100}% |
              | Best Practices | ${manifest[0].summary['best-practices'] * 100}% |
              | SEO | ${manifest[0].summary.seo * 100}% |

              [View Full Report](${manifest[0].url})
              `;

              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

      - name: âŒ Fail if scores below threshold
        run: |
          echo "Checking Lighthouse scores..."
          # Los thresholds estÃ¡n definidos en lighthouserc.json
          # Este paso fallarÃ¡ automÃ¡ticamente si no se cumplen
