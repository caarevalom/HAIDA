name: HAIDA CI/CD - Production Ready

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  ci-tests:
    name: CI Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install all dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Validate file structure
        run: |
          [ -f "app/main.py" ] && echo "âœ… main.py exists" || exit 1
          [ -d "app/core" ] && echo "âœ… core/ exists" || exit 1
          [ -d "app/routes" ] && echo "âœ… routes/ exists" || exit 1
          echo "âœ… File structure validation passed"

      - name: Compile Python files
        run: |
          python -m compileall app/ || exit 1
          echo "âœ… All Python files compiled successfully"

      - name: Test core imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from fastapi import FastAPI
          from app.core.logging import setup_logging
          from app.core.middleware import RequestIdMiddleware
          from app.core.cors import setup_cors
          print('âœ… Core imports successful')
          "

      - name: Test application imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          import app.main
          print('âœ… Application imports successful')
          "

      - name: Test FastAPI app and health endpoint
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from app.main import app
          print(f'âœ… FastAPI app created with {len(app.routes)} routes')
          "

      - name: Test health endpoint with TestClient
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from app.main import app
          from fastapi.testclient import TestClient

          client = TestClient(app)
          response = client.get('/health')
          assert response.status_code == 200, f'Health check failed: {response.status_code}'
          data = response.json()
          assert 'status' in data, 'Response missing status field'
          print(f'âœ… Health endpoint test passed: {data}')
          "

      - name: Test OpenAPI schema
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from app.main import app
          from fastapi.testclient import TestClient

          client = TestClient(app)
          response = client.get('/openapi.json')
          assert response.status_code == 200, 'OpenAPI schema failed'
          schema = response.json()
          assert 'openapi' in schema, 'Invalid OpenAPI schema'
          print(f'âœ… OpenAPI schema test passed')
          "

      - name: All tests passed
        run: |
          echo ""
          echo "======================================"
          echo "âœ… ALL CI TESTS PASSED SUCCESSFULLY!"
          echo "======================================"
          echo ""
          echo "ðŸ“Š Test Results:"
          echo "  âœ… File structure validation"
          echo "  âœ… Python compilation check"
          echo "  âœ… Core imports validation"
          echo "  âœ… Application imports validation"
          echo "  âœ… FastAPI app creation"
          echo "  âœ… Health endpoint test"
          echo "  âœ… OpenAPI schema test"
          echo ""
          echo "ðŸš€ Ready for deployment!"
