name: HAIDA CI/CD - Minimal & Robust

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  # ===== MINIMAL CI - JUST ESSENTIALS =====
  ci:
    name: CI & Deploy
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal dependencies
        run: |
          pip install --upgrade pip
          pip install fastapi uvicorn python-dotenv

      - name: Validate file structure
        run: |
          [ -f "app/main.py" ] && echo "‚úÖ main.py exists" || exit 1
          [ -d "app/core" ] && echo "‚úÖ core exists" || exit 1
          [ -d "app/routes" ] && echo "‚úÖ routes exists" || exit 1

      - name: Check Python syntax
        run: |
          python -m py_compile app/main.py || exit 1
          echo "‚úÖ Syntax check passed"

      - name: Test basic imports
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          import app.main
          print('‚úÖ Basic imports work')
          " || exit 1

      - name: Test FastAPI app creation
        run: |
          python -c "
          import sys
          sys.path.insert(0, '.')
          from app.main import app
          from fastapi.testclient import TestClient

          client = TestClient(app)
          response = client.get('/health')
          assert response.status_code == 200
          print('‚úÖ FastAPI app works')
          " || exit 1

      # ===== DEPLOYMENT =====
      - name: Deploy to Vercel
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          npm install -g vercel
          vercel --prod --token ${{ secrets.VERCEL_TOKEN }} --yes --force
        env:
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deployment success
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
        run: |
          echo "üéâ HAIDA deployed successfully!"
          echo "üåê Check https://vercel.com/dashboard for URL"
